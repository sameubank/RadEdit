express = require "express"
global.app = express()
global.io = require('socket.io').listen(app.listen(config.port), {log: false})

log.info "Listening on port #{config.port}."

app.on = (method, routePath, callback) ->
	existingRoute = null
	routes = app.routes[method] or []
	routes.forEach (route, i) ->
		existingRoute = route	if route.path is routePath

	if existingRoute
		existingRoute.callbacks = [callback]
	else
		app.get routePath, callback

app.on 'GET', '/ping', (request, response) ->
	response.send {}


global.send = (response, viewName, context) ->
	response.send loader.views[viewName] context


io.connect = (callback) ->
	io.sockets.on 'connection', callback

io.connect (socket) ->

	socket.on 'error', (error) ->
		log error